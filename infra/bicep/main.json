{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "3804620473958812481"
    }
  },
  "parameters": {
    "environment": {
      "type": "string",
      "defaultValue": "dev",
      "allowedValues": [
        "dev",
        "staging",
        "prod"
      ],
      "metadata": {
        "description": "Environment name (dev, staging, prod)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "eastus",
      "metadata": {
        "description": "Azure region for resources - defaults to eastus to match AI Search"
      }
    },
    "projectName": {
      "type": "string",
      "defaultValue": "keikoteach",
      "metadata": {
        "description": "Project name used for resource naming"
      }
    },
    "existingSearchServiceName": {
      "type": "string",
      "defaultValue": "gptkb-vyuvvvwlwg5jo",
      "metadata": {
        "description": "Existing Azure AI Search service name"
      }
    },
    "imageTag": {
      "type": "string",
      "defaultValue": "latest",
      "metadata": {
        "description": "Container image tag to deploy"
      }
    },
    "azureAdB2cTenantName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Azure AD B2C tenant name (optional)"
      }
    },
    "azureAdB2cClientId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Azure AD B2C client ID (optional)"
      }
    },
    "foundryEndpoint": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Microsoft Foundry endpoint (optional)"
      }
    },
    "foundryProjectName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Microsoft Foundry project name (optional)"
      }
    }
  },
  "variables": {
    "uniqueSuffix": "[uniqueString(resourceGroup().id)]",
    "shortSuffix": "[take(variables('uniqueSuffix'), 6)]",
    "resourceSuffix": "[format('{0}{1}', parameters('projectName'), parameters('environment'))]",
    "tags": {
      "project": "keiko-for-teaching",
      "environment": "[parameters('environment')]",
      "managedBy": "bicep"
    },
    "names": {
      "logAnalytics": "[format('log-{0}', variables('resourceSuffix'))]",
      "appInsights": "[format('appi-{0}', variables('resourceSuffix'))]",
      "containerRegistry": "[format('acr{0}{1}', parameters('projectName'), variables('shortSuffix'))]",
      "containerAppsEnv": "[format('cae-{0}', variables('resourceSuffix'))]",
      "keyVault": "[format('kv-{0}-{1}', parameters('projectName'), variables('shortSuffix'))]",
      "storageAccount": "[format('st{0}{1}', parameters('projectName'), variables('shortSuffix'))]",
      "redis": "[format('redis-{0}', variables('resourceSuffix'))]",
      "managedIdentity": "[format('id-{0}', variables('resourceSuffix'))]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "log-analytics-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('names').logAnalytics]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "retentionInDays": "[if(equals(parameters('environment'), 'prod'), createObject('value', 90), createObject('value', 30))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "14235812661089932231"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Log Analytics Workspace"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the resource"
              }
            },
            "retentionInDays": {
              "type": "int",
              "defaultValue": 30,
              "minValue": 30,
              "maxValue": 730,
              "metadata": {
                "description": "Retention period in days"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "PerGB2018",
              "allowedValues": [
                "Free",
                "PerGB2018",
                "PerNode",
                "Premium",
                "Standalone",
                "Standard"
              ],
              "metadata": {
                "description": "SKU for the workspace"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "[parameters('sku')]"
                },
                "retentionInDays": "[parameters('retentionInDays')]",
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                },
                "workspaceCapping": {
                  "dailyQuotaGb": -1
                },
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            }
          ],
          "outputs": {
            "workspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace resource ID"
              },
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('name'))]"
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace name"
              },
              "value": "[parameters('name')]"
            },
            "customerId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace customer ID (for agents)"
              },
              "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('name')), '2023-09-01').customerId]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "app-insights-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('names').appInsights]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'log-analytics-deployment'), '2025-04-01').outputs.workspaceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "7455407947526764592"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Application Insights resource"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the resource"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace ID for data storage"
              }
            },
            "applicationType": {
              "type": "string",
              "defaultValue": "web",
              "allowedValues": [
                "web",
                "other"
              ],
              "metadata": {
                "description": "Application type"
              }
            },
            "retentionInDays": {
              "type": "int",
              "defaultValue": 90,
              "minValue": 30,
              "maxValue": 730,
              "metadata": {
                "description": "Retention period in days"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "[parameters('applicationType')]",
              "properties": {
                "Application_Type": "[parameters('applicationType')]",
                "WorkspaceResourceId": "[parameters('logAnalyticsWorkspaceId')]",
                "RetentionInDays": "[parameters('retentionInDays')]",
                "IngestionMode": "LogAnalytics",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled",
                "DisableIpMasking": false,
                "DisableLocalAuth": false
              }
            }
          ],
          "outputs": {
            "appInsightsId": {
              "type": "string",
              "metadata": {
                "description": "Application Insights resource ID"
              },
              "value": "[resourceId('Microsoft.Insights/components', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Application Insights name"
              },
              "value": "[parameters('name')]"
            },
            "instrumentationKey": {
              "type": "string",
              "metadata": {
                "description": "Application Insights instrumentation key"
              },
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('name')), '2020-02-02').InstrumentationKey]"
            },
            "connectionString": {
              "type": "string",
              "metadata": {
                "description": "Application Insights connection string"
              },
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('name')), '2020-02-02').ConnectionString]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'log-analytics-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "managed-identity-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('names').managedIdentity]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "10207159739981727801"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Managed Identity"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the resource"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "identityId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity resource ID"
              },
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name'))]"
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity principal ID (object ID)"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').principalId]"
            },
            "clientId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity client ID (application ID)"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').clientId]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity name"
              },
              "value": "[parameters('name')]"
            },
            "tenantId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity tenant ID"
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').tenantId]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "container-registry-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('names').containerRegistry]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "sku": "[if(equals(parameters('environment'), 'prod'), createObject('value', 'Premium'), createObject('value', 'Basic'))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "16662670512898282929"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container Registry (must be globally unique)"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the resource"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Basic",
              "allowedValues": [
                "Basic",
                "Standard",
                "Premium"
              ],
              "metadata": {
                "description": "SKU for the Container Registry"
              }
            },
            "adminUserEnabled": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable admin user for the registry"
              }
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "Enabled",
              "metadata": {
                "description": "Enable public network access"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-11-01-preview",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]"
              },
              "properties": {
                "adminUserEnabled": "[parameters('adminUserEnabled')]",
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                "policies": {
                  "quarantinePolicy": {
                    "status": "disabled"
                  },
                  "trustPolicy": {
                    "type": "Notary",
                    "status": "disabled"
                  },
                  "retentionPolicy": {
                    "days": 7,
                    "status": "[if(equals(parameters('sku'), 'Premium'), 'enabled', 'disabled')]"
                  }
                },
                "encryption": {
                  "status": "disabled"
                },
                "dataEndpointEnabled": false,
                "networkRuleBypassOptions": "AzureServices",
                "zoneRedundancy": "[if(equals(parameters('sku'), 'Premium'), 'Enabled', 'Disabled')]"
              }
            }
          ],
          "outputs": {
            "registryId": {
              "type": "string",
              "metadata": {
                "description": "Container Registry resource ID"
              },
              "value": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Container Registry name"
              },
              "value": "[parameters('name')]"
            },
            "loginServer": {
              "type": "string",
              "metadata": {
                "description": "Container Registry login server"
              },
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('name')), '2023-11-01-preview').loginServer]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "key-vault-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('names').keyVault]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "managedIdentityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment'), '2025-04-01').outputs.principalId.value]"
          },
          "enablePurgeProtection": {
            "value": "[equals(parameters('environment'), 'prod')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "1243765087606891300"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Key Vault"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the resource"
              }
            },
            "managedIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity principal ID for access"
              }
            },
            "enablePurgeProtection": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable purge protection"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "standard",
              "allowedValues": [
                "standard",
                "premium"
              ],
              "metadata": {
                "description": "SKU for the Key Vault"
              }
            },
            "softDeleteRetentionInDays": {
              "type": "int",
              "defaultValue": 90,
              "minValue": 7,
              "maxValue": 90,
              "metadata": {
                "description": "Soft delete retention in days"
              }
            },
            "tenantId": {
              "type": "string",
              "defaultValue": "[subscription().tenantId]",
              "metadata": {
                "description": "Tenant ID for Azure AD"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "tenantId": "[parameters('tenantId')]",
                "sku": {
                  "family": "A",
                  "name": "[parameters('sku')]"
                },
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": "[parameters('softDeleteRetentionInDays')]",
                "enablePurgeProtection": "[if(parameters('enablePurgeProtection'), true(), null())]",
                "enableRbacAuthorization": true,
                "publicNetworkAccess": "Enabled",
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "Allow"
                }
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('name'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('name')), parameters('managedIdentityPrincipalId'), 'Key Vault Secrets Officer')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b86a8fe4-44ce-4948-aee5-eccb2c155cd7')]",
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "keyVaultId": {
              "type": "string",
              "metadata": {
                "description": "Key Vault resource ID"
              },
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              },
              "value": "[parameters('name')]"
            },
            "vaultUri": {
              "type": "string",
              "metadata": {
                "description": "Key Vault URI"
              },
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('name')), '2023-07-01').vaultUri]"
            },
            "tenantId": {
              "type": "string",
              "metadata": {
                "description": "Key Vault tenant ID"
              },
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('name')), '2023-07-01').tenantId]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "storage-account-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('names').storageAccount]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "managedIdentityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment'), '2025-04-01').outputs.principalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "3540970556065989510"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Storage Account (must be globally unique)"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the resource"
              }
            },
            "managedIdentityPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Managed Identity principal ID for access"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Standard_LRS",
              "allowedValues": [
                "Standard_LRS",
                "Standard_GRS",
                "Standard_RAGRS",
                "Standard_ZRS",
                "Premium_LRS"
              ],
              "metadata": {
                "description": "SKU for the Storage Account"
              }
            },
            "kind": {
              "type": "string",
              "defaultValue": "StorageV2",
              "allowedValues": [
                "StorageV2",
                "BlobStorage",
                "BlockBlobStorage"
              ],
              "metadata": {
                "description": "Storage Account kind"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]"
              },
              "kind": "[parameters('kind')]",
              "properties": {
                "accessTier": "Hot",
                "allowBlobPublicAccess": false,
                "allowSharedKeyAccess": true,
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true,
                "encryption": {
                  "services": {
                    "blob": {
                      "enabled": true,
                      "keyType": "Account"
                    },
                    "file": {
                      "enabled": true,
                      "keyType": "Account"
                    }
                  },
                  "keySource": "Microsoft.Storage"
                },
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "Allow"
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('name'), 'default')]",
              "properties": {
                "deleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                },
                "containerDeleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}/{2}', parameters('name'), 'default', 'documents')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('name'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('name'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), parameters('managedIdentityPrincipalId'), 'Storage Blob Data Contributor')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "storageAccountId": {
              "type": "string",
              "metadata": {
                "description": "Storage Account resource ID"
              },
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Storage Account name"
              },
              "value": "[parameters('name')]"
            },
            "primaryBlobEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Storage Account primary blob endpoint"
              },
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '2023-05-01').primaryEndpoints.blob]"
            },
            "documentsContainerName": {
              "type": "string",
              "metadata": {
                "description": "Documents container name"
              },
              "value": "documents"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "redis-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('names').redis]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "sku": "[if(equals(parameters('environment'), 'prod'), createObject('value', 'Standard'), createObject('value', 'Basic'))]",
          "capacity": "[if(equals(parameters('environment'), 'prod'), createObject('value', 1), createObject('value', 0))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "8773416996355530408"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Redis Cache"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the resource"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Basic",
              "allowedValues": [
                "Basic",
                "Standard",
                "Premium"
              ],
              "metadata": {
                "description": "SKU for the Redis Cache"
              }
            },
            "capacity": {
              "type": "int",
              "defaultValue": 0,
              "minValue": 0,
              "maxValue": 6,
              "metadata": {
                "description": "Capacity (size) of the Redis Cache"
              }
            },
            "enableNonSslPort": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable non-SSL port (not recommended)"
              }
            },
            "minimumTlsVersion": {
              "type": "string",
              "defaultValue": "1.2",
              "allowedValues": [
                "1.0",
                "1.1",
                "1.2"
              ],
              "metadata": {
                "description": "Minimum TLS version"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Cache/redis",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "[parameters('sku')]",
                  "family": "[if(equals(parameters('sku'), 'Premium'), 'P', 'C')]",
                  "capacity": "[parameters('capacity')]"
                },
                "enableNonSslPort": "[parameters('enableNonSslPort')]",
                "minimumTlsVersion": "[parameters('minimumTlsVersion')]",
                "redisConfiguration": {
                  "maxmemory-policy": "volatile-lru"
                },
                "publicNetworkAccess": "Enabled"
              }
            }
          ],
          "outputs": {
            "redisCacheId": {
              "type": "string",
              "metadata": {
                "description": "Redis Cache resource ID"
              },
              "value": "[resourceId('Microsoft.Cache/redis', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Redis Cache name"
              },
              "value": "[parameters('name')]"
            },
            "hostname": {
              "type": "string",
              "metadata": {
                "description": "Redis Cache hostname"
              },
              "value": "[reference(resourceId('Microsoft.Cache/redis', parameters('name')), '2024-03-01').hostName]"
            },
            "sslPort": {
              "type": "int",
              "metadata": {
                "description": "Redis Cache SSL port"
              },
              "value": "[reference(resourceId('Microsoft.Cache/redis', parameters('name')), '2024-03-01').sslPort]"
            },
            "port": {
              "type": "int",
              "metadata": {
                "description": "Redis Cache non-SSL port"
              },
              "value": "[reference(resourceId('Microsoft.Cache/redis', parameters('name')), '2024-03-01').port]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "key-vault-secrets-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'key-vault-deployment'), '2025-04-01').outputs.name.value]"
          },
          "redisCacheName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'redis-deployment'), '2025-04-01').outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "16858275711756764802"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Key Vault"
              }
            },
            "redisCacheName": {
              "type": "string",
              "metadata": {
                "description": "Redis Cache name"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'redis-password')]",
              "properties": {
                "value": "[listKeys(resourceId('Microsoft.Cache/redis', parameters('redisCacheName')), '2024-03-01').primaryKey]"
              }
            }
          ],
          "outputs": {
            "redisPasswordSecretUri": {
              "type": "string",
              "metadata": {
                "description": "Redis password secret URI"
              },
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), 'redis-password'), '2023-07-01').secretUri]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'key-vault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'redis-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "container-apps-env-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('names').containerAppsEnv]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'log-analytics-deployment'), '2025-04-01').outputs.workspaceId.value]"
          },
          "appInsightsConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-insights-deployment'), '2025-04-01').outputs.connectionString.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "4499196455997607196"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container Apps Environment"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the resource"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace ID for logging"
              }
            },
            "appInsightsConnectionString": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights connection string"
              }
            },
            "zoneRedundant": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable zone redundancy"
              }
            },
            "workloadProfileType": {
              "type": "string",
              "defaultValue": "Consumption",
              "allowedValues": [
                "Consumption",
                "D4",
                "D8",
                "D16",
                "D32",
                "E4",
                "E8",
                "E16",
                "E32"
              ],
              "metadata": {
                "description": "Workload profile type"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceId'), '/')[8]), '2023-09-01').customerId]",
                    "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', split(parameters('logAnalyticsWorkspaceId'), '/')[8]), '2023-09-01').primarySharedKey]"
                  }
                },
                "daprAIConnectionString": "[parameters('appInsightsConnectionString')]",
                "zoneRedundant": "[parameters('zoneRedundant')]",
                "workloadProfiles": "[if(equals(parameters('workloadProfileType'), 'Consumption'), createArray(createObject('name', 'Consumption', 'workloadProfileType', 'Consumption')), createArray(createObject('name', 'Consumption', 'workloadProfileType', 'Consumption'), createObject('name', parameters('workloadProfileType'), 'workloadProfileType', parameters('workloadProfileType'), 'minimumCount', 1, 'maximumCount', 3)))]"
              }
            }
          ],
          "outputs": {
            "environmentId": {
              "type": "string",
              "metadata": {
                "description": "Container Apps Environment resource ID"
              },
              "value": "[resourceId('Microsoft.App/managedEnvironments', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Container Apps Environment name"
              },
              "value": "[parameters('name')]"
            },
            "defaultDomain": {
              "type": "string",
              "metadata": {
                "description": "Container Apps Environment default domain"
              },
              "value": "[reference(resourceId('Microsoft.App/managedEnvironments', parameters('name')), '2024-03-01').defaultDomain]"
            },
            "staticIp": {
              "type": "string",
              "metadata": {
                "description": "Container Apps Environment static IP"
              },
              "value": "[reference(resourceId('Microsoft.App/managedEnvironments', parameters('name')), '2024-03-01').staticIp]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'app-insights-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'log-analytics-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "frontend-app-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('ca-frontend-{0}', parameters('environment'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "containerAppsEnvId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-apps-env-deployment'), '2025-04-01').outputs.environmentId.value]"
          },
          "containerRegistryName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-registry-deployment'), '2025-04-01').outputs.name.value]"
          },
          "managedIdentityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment'), '2025-04-01').outputs.identityId.value]"
          },
          "imageName": {
            "value": "frontend"
          },
          "imageTag": {
            "value": "[parameters('imageTag')]"
          },
          "targetPort": {
            "value": 3000
          },
          "isExternal": {
            "value": true
          },
          "cpu": {
            "value": "0.5"
          },
          "memory": {
            "value": "1Gi"
          },
          "minReplicas": "[if(equals(parameters('environment'), 'prod'), createObject('value', 2), createObject('value', 1))]",
          "maxReplicas": "[if(equals(parameters('environment'), 'prod'), createObject('value', 10), createObject('value', 3))]",
          "envVars": {
            "value": [
              {
                "name": "NEXT_PUBLIC_API_URL",
                "value": "[format('https://ca-gateway-{0}.{1}', parameters('environment'), reference(resourceId('Microsoft.Resources/deployments', 'container-apps-env-deployment'), '2025-04-01').outputs.defaultDomain.value)]"
              },
              {
                "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-insights-deployment'), '2025-04-01').outputs.connectionString.value]"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "1548461273443967945"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container App"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the resource"
              }
            },
            "containerAppsEnvId": {
              "type": "string",
              "metadata": {
                "description": "Container Apps Environment ID"
              }
            },
            "containerRegistryName": {
              "type": "string",
              "metadata": {
                "description": "Container Registry name"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "User-Assigned Managed Identity ID"
              }
            },
            "imageName": {
              "type": "string",
              "metadata": {
                "description": "Container image name (without registry)"
              }
            },
            "imageTag": {
              "type": "string",
              "defaultValue": "latest",
              "metadata": {
                "description": "Container image tag"
              }
            },
            "targetPort": {
              "type": "int",
              "defaultValue": 8080,
              "metadata": {
                "description": "Target port for the container"
              }
            },
            "isExternal": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Whether the app is externally accessible"
              }
            },
            "cpu": {
              "type": "string",
              "defaultValue": "0.5",
              "metadata": {
                "description": "CPU allocation (e.g., 0.5, 1, 2)"
              }
            },
            "memory": {
              "type": "string",
              "defaultValue": "1Gi",
              "metadata": {
                "description": "Memory allocation (e.g., 1Gi, 2Gi)"
              }
            },
            "minReplicas": {
              "type": "int",
              "defaultValue": 1,
              "minValue": 0,
              "maxValue": 30,
              "metadata": {
                "description": "Minimum number of replicas"
              }
            },
            "maxReplicas": {
              "type": "int",
              "defaultValue": 3,
              "minValue": 1,
              "maxValue": 30,
              "metadata": {
                "description": "Maximum number of replicas"
              }
            },
            "envVars": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Environment variables for the container"
              }
            },
            "secrets": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Secrets for the container (Key Vault references)"
              }
            },
            "transportProtocol": {
              "type": "string",
              "defaultValue": "auto",
              "allowedValues": [
                "auto",
                "http",
                "http2"
              ],
              "metadata": {
                "description": "Transport protocol (auto, http, http2)"
              }
            },
            "workloadProfileName": {
              "type": "string",
              "defaultValue": "Consumption",
              "metadata": {
                "description": "Workload profile name"
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "secretsConfig",
                "count": "[length(parameters('secrets'))]",
                "input": {
                  "name": "[parameters('secrets')[copyIndex('secretsConfig')].name]",
                  "keyVaultUrl": "[parameters('secrets')[copyIndex('secretsConfig')].keyVaultSecretUri]",
                  "identity": "[parameters('managedIdentityId')]"
                }
              },
              {
                "name": "secretEnvVars",
                "count": "[length(parameters('secrets'))]",
                "input": {
                  "name": "[replace(toUpper(replace(parameters('secrets')[copyIndex('secretEnvVars')].name, '-', '_')), ' ', '_')]",
                  "secretRef": "[parameters('secrets')[copyIndex('secretEnvVars')].name]"
                }
              }
            ],
            "allEnvVars": "[union(parameters('envVars'), variables('secretEnvVars'))]"
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[parameters('containerAppsEnvId')]",
                "workloadProfileName": "[parameters('workloadProfileName')]",
                "configuration": {
                  "activeRevisionsMode": "Single",
                  "ingress": {
                    "external": "[parameters('isExternal')]",
                    "targetPort": "[parameters('targetPort')]",
                    "transport": "[parameters('transportProtocol')]",
                    "allowInsecure": false,
                    "traffic": [
                      {
                        "latestRevision": true,
                        "weight": 100
                      }
                    ],
                    "corsPolicy": "[if(parameters('isExternal'), createObject('allowedOrigins', createArray('*'), 'allowedMethods', createArray('GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'), 'allowedHeaders', createArray('*'), 'maxAge', 86400), null())]"
                  },
                  "registries": [
                    {
                      "server": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-11-01-preview').loginServer]",
                      "identity": "[parameters('managedIdentityId')]"
                    }
                  ],
                  "secrets": "[variables('secretsConfig')]"
                },
                "template": {
                  "containers": [
                    {
                      "name": "[parameters('imageName')]",
                      "image": "[format('{0}/{1}:{2}', reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-11-01-preview').loginServer, parameters('imageName'), parameters('imageTag'))]",
                      "resources": {
                        "cpu": "[json(parameters('cpu'))]",
                        "memory": "[parameters('memory')]"
                      },
                      "env": "[variables('allEnvVars')]",
                      "probes": [
                        {
                          "type": "Liveness",
                          "httpGet": {
                            "path": "/health",
                            "port": "[parameters('targetPort')]"
                          },
                          "initialDelaySeconds": 30,
                          "periodSeconds": 30,
                          "failureThreshold": 3
                        },
                        {
                          "type": "Readiness",
                          "httpGet": {
                            "path": "/health",
                            "port": "[parameters('targetPort')]"
                          },
                          "initialDelaySeconds": 10,
                          "periodSeconds": 10,
                          "failureThreshold": 3
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": "[parameters('minReplicas')]",
                    "maxReplicas": "[parameters('maxReplicas')]",
                    "rules": [
                      {
                        "name": "http-scaling",
                        "http": {
                          "metadata": {
                            "concurrentRequests": "100"
                          }
                        }
                      }
                    ]
                  }
                }
              }
            }
          ],
          "outputs": {
            "containerAppId": {
              "type": "string",
              "metadata": {
                "description": "Container App resource ID"
              },
              "value": "[resourceId('Microsoft.App/containerApps', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Container App name"
              },
              "value": "[parameters('name')]"
            },
            "fqdn": {
              "type": "string",
              "metadata": {
                "description": "Container App FQDN"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').configuration.ingress.fqdn]"
            },
            "latestRevisionName": {
              "type": "string",
              "metadata": {
                "description": "Container App latest revision name"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').latestRevisionName]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'app-insights-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'container-apps-env-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'container-registry-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "gateway-app-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('ca-gateway-{0}', parameters('environment'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "containerAppsEnvId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-apps-env-deployment'), '2025-04-01').outputs.environmentId.value]"
          },
          "containerRegistryName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-registry-deployment'), '2025-04-01').outputs.name.value]"
          },
          "managedIdentityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment'), '2025-04-01').outputs.identityId.value]"
          },
          "imageName": {
            "value": "gateway-bff"
          },
          "imageTag": {
            "value": "[parameters('imageTag')]"
          },
          "targetPort": {
            "value": 8000
          },
          "isExternal": {
            "value": true
          },
          "cpu": {
            "value": "0.5"
          },
          "memory": {
            "value": "1Gi"
          },
          "minReplicas": "[if(equals(parameters('environment'), 'prod'), createObject('value', 2), createObject('value', 1))]",
          "maxReplicas": "[if(equals(parameters('environment'), 'prod'), createObject('value', 10), createObject('value', 3))]",
          "envVars": {
            "value": [
              {
                "name": "CHAT_SERVICE_URL",
                "value": "[format('http://ca-chat-{0}', parameters('environment'))]"
              },
              {
                "name": "SEARCH_SERVICE_URL",
                "value": "[format('http://ca-search-{0}', parameters('environment'))]"
              },
              {
                "name": "DOCUMENT_SERVICE_URL",
                "value": "[format('http://ca-document-{0}', parameters('environment'))]"
              },
              {
                "name": "AUTH_SERVICE_URL",
                "value": "[format('http://ca-auth-{0}', parameters('environment'))]"
              },
              {
                "name": "USER_SERVICE_URL",
                "value": "[format('http://ca-user-{0}', parameters('environment'))]"
              },
              {
                "name": "REDIS_URL",
                "value": "[format('rediss://{0}:{1}', reference(resourceId('Microsoft.Resources/deployments', 'redis-deployment'), '2025-04-01').outputs.hostname.value, reference(resourceId('Microsoft.Resources/deployments', 'redis-deployment'), '2025-04-01').outputs.sslPort.value)]"
              },
              {
                "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-insights-deployment'), '2025-04-01').outputs.connectionString.value]"
              },
              {
                "name": "AZURE_CLIENT_ID",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment'), '2025-04-01').outputs.clientId.value]"
              }
            ]
          },
          "secrets": {
            "value": [
              {
                "name": "redis-password",
                "keyVaultSecretUri": "[format('{0}secrets/redis-password', reference(resourceId('Microsoft.Resources/deployments', 'key-vault-deployment'), '2025-04-01').outputs.vaultUri.value)]"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "1548461273443967945"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container App"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the resource"
              }
            },
            "containerAppsEnvId": {
              "type": "string",
              "metadata": {
                "description": "Container Apps Environment ID"
              }
            },
            "containerRegistryName": {
              "type": "string",
              "metadata": {
                "description": "Container Registry name"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "User-Assigned Managed Identity ID"
              }
            },
            "imageName": {
              "type": "string",
              "metadata": {
                "description": "Container image name (without registry)"
              }
            },
            "imageTag": {
              "type": "string",
              "defaultValue": "latest",
              "metadata": {
                "description": "Container image tag"
              }
            },
            "targetPort": {
              "type": "int",
              "defaultValue": 8080,
              "metadata": {
                "description": "Target port for the container"
              }
            },
            "isExternal": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Whether the app is externally accessible"
              }
            },
            "cpu": {
              "type": "string",
              "defaultValue": "0.5",
              "metadata": {
                "description": "CPU allocation (e.g., 0.5, 1, 2)"
              }
            },
            "memory": {
              "type": "string",
              "defaultValue": "1Gi",
              "metadata": {
                "description": "Memory allocation (e.g., 1Gi, 2Gi)"
              }
            },
            "minReplicas": {
              "type": "int",
              "defaultValue": 1,
              "minValue": 0,
              "maxValue": 30,
              "metadata": {
                "description": "Minimum number of replicas"
              }
            },
            "maxReplicas": {
              "type": "int",
              "defaultValue": 3,
              "minValue": 1,
              "maxValue": 30,
              "metadata": {
                "description": "Maximum number of replicas"
              }
            },
            "envVars": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Environment variables for the container"
              }
            },
            "secrets": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Secrets for the container (Key Vault references)"
              }
            },
            "transportProtocol": {
              "type": "string",
              "defaultValue": "auto",
              "allowedValues": [
                "auto",
                "http",
                "http2"
              ],
              "metadata": {
                "description": "Transport protocol (auto, http, http2)"
              }
            },
            "workloadProfileName": {
              "type": "string",
              "defaultValue": "Consumption",
              "metadata": {
                "description": "Workload profile name"
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "secretsConfig",
                "count": "[length(parameters('secrets'))]",
                "input": {
                  "name": "[parameters('secrets')[copyIndex('secretsConfig')].name]",
                  "keyVaultUrl": "[parameters('secrets')[copyIndex('secretsConfig')].keyVaultSecretUri]",
                  "identity": "[parameters('managedIdentityId')]"
                }
              },
              {
                "name": "secretEnvVars",
                "count": "[length(parameters('secrets'))]",
                "input": {
                  "name": "[replace(toUpper(replace(parameters('secrets')[copyIndex('secretEnvVars')].name, '-', '_')), ' ', '_')]",
                  "secretRef": "[parameters('secrets')[copyIndex('secretEnvVars')].name]"
                }
              }
            ],
            "allEnvVars": "[union(parameters('envVars'), variables('secretEnvVars'))]"
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[parameters('containerAppsEnvId')]",
                "workloadProfileName": "[parameters('workloadProfileName')]",
                "configuration": {
                  "activeRevisionsMode": "Single",
                  "ingress": {
                    "external": "[parameters('isExternal')]",
                    "targetPort": "[parameters('targetPort')]",
                    "transport": "[parameters('transportProtocol')]",
                    "allowInsecure": false,
                    "traffic": [
                      {
                        "latestRevision": true,
                        "weight": 100
                      }
                    ],
                    "corsPolicy": "[if(parameters('isExternal'), createObject('allowedOrigins', createArray('*'), 'allowedMethods', createArray('GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'), 'allowedHeaders', createArray('*'), 'maxAge', 86400), null())]"
                  },
                  "registries": [
                    {
                      "server": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-11-01-preview').loginServer]",
                      "identity": "[parameters('managedIdentityId')]"
                    }
                  ],
                  "secrets": "[variables('secretsConfig')]"
                },
                "template": {
                  "containers": [
                    {
                      "name": "[parameters('imageName')]",
                      "image": "[format('{0}/{1}:{2}', reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-11-01-preview').loginServer, parameters('imageName'), parameters('imageTag'))]",
                      "resources": {
                        "cpu": "[json(parameters('cpu'))]",
                        "memory": "[parameters('memory')]"
                      },
                      "env": "[variables('allEnvVars')]",
                      "probes": [
                        {
                          "type": "Liveness",
                          "httpGet": {
                            "path": "/health",
                            "port": "[parameters('targetPort')]"
                          },
                          "initialDelaySeconds": 30,
                          "periodSeconds": 30,
                          "failureThreshold": 3
                        },
                        {
                          "type": "Readiness",
                          "httpGet": {
                            "path": "/health",
                            "port": "[parameters('targetPort')]"
                          },
                          "initialDelaySeconds": 10,
                          "periodSeconds": 10,
                          "failureThreshold": 3
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": "[parameters('minReplicas')]",
                    "maxReplicas": "[parameters('maxReplicas')]",
                    "rules": [
                      {
                        "name": "http-scaling",
                        "http": {
                          "metadata": {
                            "concurrentRequests": "100"
                          }
                        }
                      }
                    ]
                  }
                }
              }
            }
          ],
          "outputs": {
            "containerAppId": {
              "type": "string",
              "metadata": {
                "description": "Container App resource ID"
              },
              "value": "[resourceId('Microsoft.App/containerApps', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Container App name"
              },
              "value": "[parameters('name')]"
            },
            "fqdn": {
              "type": "string",
              "metadata": {
                "description": "Container App FQDN"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').configuration.ingress.fqdn]"
            },
            "latestRevisionName": {
              "type": "string",
              "metadata": {
                "description": "Container App latest revision name"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').latestRevisionName]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'app-insights-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'container-apps-env-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'container-registry-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'key-vault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'redis-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "chat-app-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('ca-chat-{0}', parameters('environment'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "containerAppsEnvId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-apps-env-deployment'), '2025-04-01').outputs.environmentId.value]"
          },
          "containerRegistryName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-registry-deployment'), '2025-04-01').outputs.name.value]"
          },
          "managedIdentityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment'), '2025-04-01').outputs.identityId.value]"
          },
          "imageName": {
            "value": "chat-service"
          },
          "imageTag": {
            "value": "[parameters('imageTag')]"
          },
          "targetPort": {
            "value": 8001
          },
          "isExternal": {
            "value": false
          },
          "cpu": {
            "value": "1"
          },
          "memory": {
            "value": "2Gi"
          },
          "minReplicas": "[if(equals(parameters('environment'), 'prod'), createObject('value', 2), createObject('value', 1))]",
          "maxReplicas": "[if(equals(parameters('environment'), 'prod'), createObject('value', 10), createObject('value', 3))]",
          "envVars": {
            "value": [
              {
                "name": "FOUNDRY_ENDPOINT",
                "value": "[parameters('foundryEndpoint')]"
              },
              {
                "name": "FOUNDRY_PROJECT_NAME",
                "value": "[parameters('foundryProjectName')]"
              },
              {
                "name": "SEARCH_SERVICE_URL",
                "value": "[format('http://ca-search-{0}', parameters('environment'))]"
              },
              {
                "name": "REDIS_URL",
                "value": "[format('rediss://{0}:{1}', reference(resourceId('Microsoft.Resources/deployments', 'redis-deployment'), '2025-04-01').outputs.hostname.value, reference(resourceId('Microsoft.Resources/deployments', 'redis-deployment'), '2025-04-01').outputs.sslPort.value)]"
              },
              {
                "name": "AZURE_CLIENT_ID",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment'), '2025-04-01').outputs.clientId.value]"
              },
              {
                "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-insights-deployment'), '2025-04-01').outputs.connectionString.value]"
              }
            ]
          },
          "secrets": {
            "value": [
              {
                "name": "redis-password",
                "keyVaultSecretUri": "[format('{0}secrets/redis-password', reference(resourceId('Microsoft.Resources/deployments', 'key-vault-deployment'), '2025-04-01').outputs.vaultUri.value)]"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "1548461273443967945"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container App"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the resource"
              }
            },
            "containerAppsEnvId": {
              "type": "string",
              "metadata": {
                "description": "Container Apps Environment ID"
              }
            },
            "containerRegistryName": {
              "type": "string",
              "metadata": {
                "description": "Container Registry name"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "User-Assigned Managed Identity ID"
              }
            },
            "imageName": {
              "type": "string",
              "metadata": {
                "description": "Container image name (without registry)"
              }
            },
            "imageTag": {
              "type": "string",
              "defaultValue": "latest",
              "metadata": {
                "description": "Container image tag"
              }
            },
            "targetPort": {
              "type": "int",
              "defaultValue": 8080,
              "metadata": {
                "description": "Target port for the container"
              }
            },
            "isExternal": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Whether the app is externally accessible"
              }
            },
            "cpu": {
              "type": "string",
              "defaultValue": "0.5",
              "metadata": {
                "description": "CPU allocation (e.g., 0.5, 1, 2)"
              }
            },
            "memory": {
              "type": "string",
              "defaultValue": "1Gi",
              "metadata": {
                "description": "Memory allocation (e.g., 1Gi, 2Gi)"
              }
            },
            "minReplicas": {
              "type": "int",
              "defaultValue": 1,
              "minValue": 0,
              "maxValue": 30,
              "metadata": {
                "description": "Minimum number of replicas"
              }
            },
            "maxReplicas": {
              "type": "int",
              "defaultValue": 3,
              "minValue": 1,
              "maxValue": 30,
              "metadata": {
                "description": "Maximum number of replicas"
              }
            },
            "envVars": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Environment variables for the container"
              }
            },
            "secrets": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Secrets for the container (Key Vault references)"
              }
            },
            "transportProtocol": {
              "type": "string",
              "defaultValue": "auto",
              "allowedValues": [
                "auto",
                "http",
                "http2"
              ],
              "metadata": {
                "description": "Transport protocol (auto, http, http2)"
              }
            },
            "workloadProfileName": {
              "type": "string",
              "defaultValue": "Consumption",
              "metadata": {
                "description": "Workload profile name"
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "secretsConfig",
                "count": "[length(parameters('secrets'))]",
                "input": {
                  "name": "[parameters('secrets')[copyIndex('secretsConfig')].name]",
                  "keyVaultUrl": "[parameters('secrets')[copyIndex('secretsConfig')].keyVaultSecretUri]",
                  "identity": "[parameters('managedIdentityId')]"
                }
              },
              {
                "name": "secretEnvVars",
                "count": "[length(parameters('secrets'))]",
                "input": {
                  "name": "[replace(toUpper(replace(parameters('secrets')[copyIndex('secretEnvVars')].name, '-', '_')), ' ', '_')]",
                  "secretRef": "[parameters('secrets')[copyIndex('secretEnvVars')].name]"
                }
              }
            ],
            "allEnvVars": "[union(parameters('envVars'), variables('secretEnvVars'))]"
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[parameters('containerAppsEnvId')]",
                "workloadProfileName": "[parameters('workloadProfileName')]",
                "configuration": {
                  "activeRevisionsMode": "Single",
                  "ingress": {
                    "external": "[parameters('isExternal')]",
                    "targetPort": "[parameters('targetPort')]",
                    "transport": "[parameters('transportProtocol')]",
                    "allowInsecure": false,
                    "traffic": [
                      {
                        "latestRevision": true,
                        "weight": 100
                      }
                    ],
                    "corsPolicy": "[if(parameters('isExternal'), createObject('allowedOrigins', createArray('*'), 'allowedMethods', createArray('GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'), 'allowedHeaders', createArray('*'), 'maxAge', 86400), null())]"
                  },
                  "registries": [
                    {
                      "server": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-11-01-preview').loginServer]",
                      "identity": "[parameters('managedIdentityId')]"
                    }
                  ],
                  "secrets": "[variables('secretsConfig')]"
                },
                "template": {
                  "containers": [
                    {
                      "name": "[parameters('imageName')]",
                      "image": "[format('{0}/{1}:{2}', reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-11-01-preview').loginServer, parameters('imageName'), parameters('imageTag'))]",
                      "resources": {
                        "cpu": "[json(parameters('cpu'))]",
                        "memory": "[parameters('memory')]"
                      },
                      "env": "[variables('allEnvVars')]",
                      "probes": [
                        {
                          "type": "Liveness",
                          "httpGet": {
                            "path": "/health",
                            "port": "[parameters('targetPort')]"
                          },
                          "initialDelaySeconds": 30,
                          "periodSeconds": 30,
                          "failureThreshold": 3
                        },
                        {
                          "type": "Readiness",
                          "httpGet": {
                            "path": "/health",
                            "port": "[parameters('targetPort')]"
                          },
                          "initialDelaySeconds": 10,
                          "periodSeconds": 10,
                          "failureThreshold": 3
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": "[parameters('minReplicas')]",
                    "maxReplicas": "[parameters('maxReplicas')]",
                    "rules": [
                      {
                        "name": "http-scaling",
                        "http": {
                          "metadata": {
                            "concurrentRequests": "100"
                          }
                        }
                      }
                    ]
                  }
                }
              }
            }
          ],
          "outputs": {
            "containerAppId": {
              "type": "string",
              "metadata": {
                "description": "Container App resource ID"
              },
              "value": "[resourceId('Microsoft.App/containerApps', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Container App name"
              },
              "value": "[parameters('name')]"
            },
            "fqdn": {
              "type": "string",
              "metadata": {
                "description": "Container App FQDN"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').configuration.ingress.fqdn]"
            },
            "latestRevisionName": {
              "type": "string",
              "metadata": {
                "description": "Container App latest revision name"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').latestRevisionName]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'app-insights-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'container-apps-env-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'container-registry-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'key-vault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'redis-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "search-app-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('ca-search-{0}', parameters('environment'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "containerAppsEnvId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-apps-env-deployment'), '2025-04-01').outputs.environmentId.value]"
          },
          "containerRegistryName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-registry-deployment'), '2025-04-01').outputs.name.value]"
          },
          "managedIdentityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment'), '2025-04-01').outputs.identityId.value]"
          },
          "imageName": {
            "value": "search-service"
          },
          "imageTag": {
            "value": "[parameters('imageTag')]"
          },
          "targetPort": {
            "value": 8002
          },
          "isExternal": {
            "value": false
          },
          "cpu": {
            "value": "0.5"
          },
          "memory": {
            "value": "1Gi"
          },
          "minReplicas": "[if(equals(parameters('environment'), 'prod'), createObject('value', 2), createObject('value', 1))]",
          "maxReplicas": "[if(equals(parameters('environment'), 'prod'), createObject('value', 5), createObject('value', 2))]",
          "envVars": {
            "value": [
              {
                "name": "AZURE_SEARCH_ENDPOINT",
                "value": "[format('https://{0}.search.windows.net', parameters('existingSearchServiceName'))]"
              },
              {
                "name": "AZURE_SEARCH_INDEX_NAME",
                "value": "keiko-documents"
              },
              {
                "name": "REDIS_URL",
                "value": "[format('rediss://{0}:{1}', reference(resourceId('Microsoft.Resources/deployments', 'redis-deployment'), '2025-04-01').outputs.hostname.value, reference(resourceId('Microsoft.Resources/deployments', 'redis-deployment'), '2025-04-01').outputs.sslPort.value)]"
              },
              {
                "name": "AZURE_CLIENT_ID",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment'), '2025-04-01').outputs.clientId.value]"
              },
              {
                "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-insights-deployment'), '2025-04-01').outputs.connectionString.value]"
              }
            ]
          },
          "secrets": {
            "value": [
              {
                "name": "redis-password",
                "keyVaultSecretUri": "[format('{0}secrets/redis-password', reference(resourceId('Microsoft.Resources/deployments', 'key-vault-deployment'), '2025-04-01').outputs.vaultUri.value)]"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "1548461273443967945"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container App"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the resource"
              }
            },
            "containerAppsEnvId": {
              "type": "string",
              "metadata": {
                "description": "Container Apps Environment ID"
              }
            },
            "containerRegistryName": {
              "type": "string",
              "metadata": {
                "description": "Container Registry name"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "User-Assigned Managed Identity ID"
              }
            },
            "imageName": {
              "type": "string",
              "metadata": {
                "description": "Container image name (without registry)"
              }
            },
            "imageTag": {
              "type": "string",
              "defaultValue": "latest",
              "metadata": {
                "description": "Container image tag"
              }
            },
            "targetPort": {
              "type": "int",
              "defaultValue": 8080,
              "metadata": {
                "description": "Target port for the container"
              }
            },
            "isExternal": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Whether the app is externally accessible"
              }
            },
            "cpu": {
              "type": "string",
              "defaultValue": "0.5",
              "metadata": {
                "description": "CPU allocation (e.g., 0.5, 1, 2)"
              }
            },
            "memory": {
              "type": "string",
              "defaultValue": "1Gi",
              "metadata": {
                "description": "Memory allocation (e.g., 1Gi, 2Gi)"
              }
            },
            "minReplicas": {
              "type": "int",
              "defaultValue": 1,
              "minValue": 0,
              "maxValue": 30,
              "metadata": {
                "description": "Minimum number of replicas"
              }
            },
            "maxReplicas": {
              "type": "int",
              "defaultValue": 3,
              "minValue": 1,
              "maxValue": 30,
              "metadata": {
                "description": "Maximum number of replicas"
              }
            },
            "envVars": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Environment variables for the container"
              }
            },
            "secrets": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Secrets for the container (Key Vault references)"
              }
            },
            "transportProtocol": {
              "type": "string",
              "defaultValue": "auto",
              "allowedValues": [
                "auto",
                "http",
                "http2"
              ],
              "metadata": {
                "description": "Transport protocol (auto, http, http2)"
              }
            },
            "workloadProfileName": {
              "type": "string",
              "defaultValue": "Consumption",
              "metadata": {
                "description": "Workload profile name"
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "secretsConfig",
                "count": "[length(parameters('secrets'))]",
                "input": {
                  "name": "[parameters('secrets')[copyIndex('secretsConfig')].name]",
                  "keyVaultUrl": "[parameters('secrets')[copyIndex('secretsConfig')].keyVaultSecretUri]",
                  "identity": "[parameters('managedIdentityId')]"
                }
              },
              {
                "name": "secretEnvVars",
                "count": "[length(parameters('secrets'))]",
                "input": {
                  "name": "[replace(toUpper(replace(parameters('secrets')[copyIndex('secretEnvVars')].name, '-', '_')), ' ', '_')]",
                  "secretRef": "[parameters('secrets')[copyIndex('secretEnvVars')].name]"
                }
              }
            ],
            "allEnvVars": "[union(parameters('envVars'), variables('secretEnvVars'))]"
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[parameters('containerAppsEnvId')]",
                "workloadProfileName": "[parameters('workloadProfileName')]",
                "configuration": {
                  "activeRevisionsMode": "Single",
                  "ingress": {
                    "external": "[parameters('isExternal')]",
                    "targetPort": "[parameters('targetPort')]",
                    "transport": "[parameters('transportProtocol')]",
                    "allowInsecure": false,
                    "traffic": [
                      {
                        "latestRevision": true,
                        "weight": 100
                      }
                    ],
                    "corsPolicy": "[if(parameters('isExternal'), createObject('allowedOrigins', createArray('*'), 'allowedMethods', createArray('GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'), 'allowedHeaders', createArray('*'), 'maxAge', 86400), null())]"
                  },
                  "registries": [
                    {
                      "server": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-11-01-preview').loginServer]",
                      "identity": "[parameters('managedIdentityId')]"
                    }
                  ],
                  "secrets": "[variables('secretsConfig')]"
                },
                "template": {
                  "containers": [
                    {
                      "name": "[parameters('imageName')]",
                      "image": "[format('{0}/{1}:{2}', reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-11-01-preview').loginServer, parameters('imageName'), parameters('imageTag'))]",
                      "resources": {
                        "cpu": "[json(parameters('cpu'))]",
                        "memory": "[parameters('memory')]"
                      },
                      "env": "[variables('allEnvVars')]",
                      "probes": [
                        {
                          "type": "Liveness",
                          "httpGet": {
                            "path": "/health",
                            "port": "[parameters('targetPort')]"
                          },
                          "initialDelaySeconds": 30,
                          "periodSeconds": 30,
                          "failureThreshold": 3
                        },
                        {
                          "type": "Readiness",
                          "httpGet": {
                            "path": "/health",
                            "port": "[parameters('targetPort')]"
                          },
                          "initialDelaySeconds": 10,
                          "periodSeconds": 10,
                          "failureThreshold": 3
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": "[parameters('minReplicas')]",
                    "maxReplicas": "[parameters('maxReplicas')]",
                    "rules": [
                      {
                        "name": "http-scaling",
                        "http": {
                          "metadata": {
                            "concurrentRequests": "100"
                          }
                        }
                      }
                    ]
                  }
                }
              }
            }
          ],
          "outputs": {
            "containerAppId": {
              "type": "string",
              "metadata": {
                "description": "Container App resource ID"
              },
              "value": "[resourceId('Microsoft.App/containerApps', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Container App name"
              },
              "value": "[parameters('name')]"
            },
            "fqdn": {
              "type": "string",
              "metadata": {
                "description": "Container App FQDN"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').configuration.ingress.fqdn]"
            },
            "latestRevisionName": {
              "type": "string",
              "metadata": {
                "description": "Container App latest revision name"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').latestRevisionName]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'app-insights-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'container-apps-env-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'container-registry-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'key-vault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'redis-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "document-app-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('ca-document-{0}', parameters('environment'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "containerAppsEnvId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-apps-env-deployment'), '2025-04-01').outputs.environmentId.value]"
          },
          "containerRegistryName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-registry-deployment'), '2025-04-01').outputs.name.value]"
          },
          "managedIdentityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment'), '2025-04-01').outputs.identityId.value]"
          },
          "imageName": {
            "value": "document-service"
          },
          "imageTag": {
            "value": "[parameters('imageTag')]"
          },
          "targetPort": {
            "value": 8003
          },
          "isExternal": {
            "value": false
          },
          "cpu": {
            "value": "0.5"
          },
          "memory": {
            "value": "1Gi"
          },
          "minReplicas": {
            "value": 1
          },
          "maxReplicas": "[if(equals(parameters('environment'), 'prod'), createObject('value', 5), createObject('value', 2))]",
          "envVars": {
            "value": [
              {
                "name": "AZURE_STORAGE_ACCOUNT_NAME",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-account-deployment'), '2025-04-01').outputs.name.value]"
              },
              {
                "name": "AZURE_STORAGE_CONTAINER_NAME",
                "value": "documents"
              },
              {
                "name": "INGESTION_SERVICE_URL",
                "value": "[format('http://ca-ingestion-{0}:50051', parameters('environment'))]"
              },
              {
                "name": "SEARCH_SERVICE_URL",
                "value": "[format('http://ca-search-{0}', parameters('environment'))]"
              },
              {
                "name": "REDIS_URL",
                "value": "[format('rediss://{0}:{1}', reference(resourceId('Microsoft.Resources/deployments', 'redis-deployment'), '2025-04-01').outputs.hostname.value, reference(resourceId('Microsoft.Resources/deployments', 'redis-deployment'), '2025-04-01').outputs.sslPort.value)]"
              },
              {
                "name": "AZURE_CLIENT_ID",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment'), '2025-04-01').outputs.clientId.value]"
              },
              {
                "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-insights-deployment'), '2025-04-01').outputs.connectionString.value]"
              }
            ]
          },
          "secrets": {
            "value": [
              {
                "name": "redis-password",
                "keyVaultSecretUri": "[format('{0}secrets/redis-password', reference(resourceId('Microsoft.Resources/deployments', 'key-vault-deployment'), '2025-04-01').outputs.vaultUri.value)]"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "1548461273443967945"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container App"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the resource"
              }
            },
            "containerAppsEnvId": {
              "type": "string",
              "metadata": {
                "description": "Container Apps Environment ID"
              }
            },
            "containerRegistryName": {
              "type": "string",
              "metadata": {
                "description": "Container Registry name"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "User-Assigned Managed Identity ID"
              }
            },
            "imageName": {
              "type": "string",
              "metadata": {
                "description": "Container image name (without registry)"
              }
            },
            "imageTag": {
              "type": "string",
              "defaultValue": "latest",
              "metadata": {
                "description": "Container image tag"
              }
            },
            "targetPort": {
              "type": "int",
              "defaultValue": 8080,
              "metadata": {
                "description": "Target port for the container"
              }
            },
            "isExternal": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Whether the app is externally accessible"
              }
            },
            "cpu": {
              "type": "string",
              "defaultValue": "0.5",
              "metadata": {
                "description": "CPU allocation (e.g., 0.5, 1, 2)"
              }
            },
            "memory": {
              "type": "string",
              "defaultValue": "1Gi",
              "metadata": {
                "description": "Memory allocation (e.g., 1Gi, 2Gi)"
              }
            },
            "minReplicas": {
              "type": "int",
              "defaultValue": 1,
              "minValue": 0,
              "maxValue": 30,
              "metadata": {
                "description": "Minimum number of replicas"
              }
            },
            "maxReplicas": {
              "type": "int",
              "defaultValue": 3,
              "minValue": 1,
              "maxValue": 30,
              "metadata": {
                "description": "Maximum number of replicas"
              }
            },
            "envVars": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Environment variables for the container"
              }
            },
            "secrets": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Secrets for the container (Key Vault references)"
              }
            },
            "transportProtocol": {
              "type": "string",
              "defaultValue": "auto",
              "allowedValues": [
                "auto",
                "http",
                "http2"
              ],
              "metadata": {
                "description": "Transport protocol (auto, http, http2)"
              }
            },
            "workloadProfileName": {
              "type": "string",
              "defaultValue": "Consumption",
              "metadata": {
                "description": "Workload profile name"
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "secretsConfig",
                "count": "[length(parameters('secrets'))]",
                "input": {
                  "name": "[parameters('secrets')[copyIndex('secretsConfig')].name]",
                  "keyVaultUrl": "[parameters('secrets')[copyIndex('secretsConfig')].keyVaultSecretUri]",
                  "identity": "[parameters('managedIdentityId')]"
                }
              },
              {
                "name": "secretEnvVars",
                "count": "[length(parameters('secrets'))]",
                "input": {
                  "name": "[replace(toUpper(replace(parameters('secrets')[copyIndex('secretEnvVars')].name, '-', '_')), ' ', '_')]",
                  "secretRef": "[parameters('secrets')[copyIndex('secretEnvVars')].name]"
                }
              }
            ],
            "allEnvVars": "[union(parameters('envVars'), variables('secretEnvVars'))]"
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[parameters('containerAppsEnvId')]",
                "workloadProfileName": "[parameters('workloadProfileName')]",
                "configuration": {
                  "activeRevisionsMode": "Single",
                  "ingress": {
                    "external": "[parameters('isExternal')]",
                    "targetPort": "[parameters('targetPort')]",
                    "transport": "[parameters('transportProtocol')]",
                    "allowInsecure": false,
                    "traffic": [
                      {
                        "latestRevision": true,
                        "weight": 100
                      }
                    ],
                    "corsPolicy": "[if(parameters('isExternal'), createObject('allowedOrigins', createArray('*'), 'allowedMethods', createArray('GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'), 'allowedHeaders', createArray('*'), 'maxAge', 86400), null())]"
                  },
                  "registries": [
                    {
                      "server": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-11-01-preview').loginServer]",
                      "identity": "[parameters('managedIdentityId')]"
                    }
                  ],
                  "secrets": "[variables('secretsConfig')]"
                },
                "template": {
                  "containers": [
                    {
                      "name": "[parameters('imageName')]",
                      "image": "[format('{0}/{1}:{2}', reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-11-01-preview').loginServer, parameters('imageName'), parameters('imageTag'))]",
                      "resources": {
                        "cpu": "[json(parameters('cpu'))]",
                        "memory": "[parameters('memory')]"
                      },
                      "env": "[variables('allEnvVars')]",
                      "probes": [
                        {
                          "type": "Liveness",
                          "httpGet": {
                            "path": "/health",
                            "port": "[parameters('targetPort')]"
                          },
                          "initialDelaySeconds": 30,
                          "periodSeconds": 30,
                          "failureThreshold": 3
                        },
                        {
                          "type": "Readiness",
                          "httpGet": {
                            "path": "/health",
                            "port": "[parameters('targetPort')]"
                          },
                          "initialDelaySeconds": 10,
                          "periodSeconds": 10,
                          "failureThreshold": 3
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": "[parameters('minReplicas')]",
                    "maxReplicas": "[parameters('maxReplicas')]",
                    "rules": [
                      {
                        "name": "http-scaling",
                        "http": {
                          "metadata": {
                            "concurrentRequests": "100"
                          }
                        }
                      }
                    ]
                  }
                }
              }
            }
          ],
          "outputs": {
            "containerAppId": {
              "type": "string",
              "metadata": {
                "description": "Container App resource ID"
              },
              "value": "[resourceId('Microsoft.App/containerApps', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Container App name"
              },
              "value": "[parameters('name')]"
            },
            "fqdn": {
              "type": "string",
              "metadata": {
                "description": "Container App FQDN"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').configuration.ingress.fqdn]"
            },
            "latestRevisionName": {
              "type": "string",
              "metadata": {
                "description": "Container App latest revision name"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').latestRevisionName]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'app-insights-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'container-apps-env-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'container-registry-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'key-vault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'redis-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'storage-account-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "auth-app-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('ca-auth-{0}', parameters('environment'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "containerAppsEnvId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-apps-env-deployment'), '2025-04-01').outputs.environmentId.value]"
          },
          "containerRegistryName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-registry-deployment'), '2025-04-01').outputs.name.value]"
          },
          "managedIdentityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment'), '2025-04-01').outputs.identityId.value]"
          },
          "imageName": {
            "value": "auth-service"
          },
          "imageTag": {
            "value": "[parameters('imageTag')]"
          },
          "targetPort": {
            "value": 8004
          },
          "isExternal": {
            "value": false
          },
          "cpu": {
            "value": "0.25"
          },
          "memory": {
            "value": "0.5Gi"
          },
          "minReplicas": {
            "value": 1
          },
          "maxReplicas": "[if(equals(parameters('environment'), 'prod'), createObject('value', 5), createObject('value', 2))]",
          "envVars": {
            "value": [
              {
                "name": "AZURE_AD_B2C_TENANT_NAME",
                "value": "[parameters('azureAdB2cTenantName')]"
              },
              {
                "name": "AZURE_AD_B2C_CLIENT_ID",
                "value": "[parameters('azureAdB2cClientId')]"
              },
              {
                "name": "REDIS_URL",
                "value": "[format('rediss://{0}:{1}', reference(resourceId('Microsoft.Resources/deployments', 'redis-deployment'), '2025-04-01').outputs.hostname.value, reference(resourceId('Microsoft.Resources/deployments', 'redis-deployment'), '2025-04-01').outputs.sslPort.value)]"
              },
              {
                "name": "AZURE_CLIENT_ID",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment'), '2025-04-01').outputs.clientId.value]"
              },
              {
                "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-insights-deployment'), '2025-04-01').outputs.connectionString.value]"
              }
            ]
          },
          "secrets": {
            "value": [
              {
                "name": "redis-password",
                "keyVaultSecretUri": "[format('{0}secrets/redis-password', reference(resourceId('Microsoft.Resources/deployments', 'key-vault-deployment'), '2025-04-01').outputs.vaultUri.value)]"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "1548461273443967945"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container App"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the resource"
              }
            },
            "containerAppsEnvId": {
              "type": "string",
              "metadata": {
                "description": "Container Apps Environment ID"
              }
            },
            "containerRegistryName": {
              "type": "string",
              "metadata": {
                "description": "Container Registry name"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "User-Assigned Managed Identity ID"
              }
            },
            "imageName": {
              "type": "string",
              "metadata": {
                "description": "Container image name (without registry)"
              }
            },
            "imageTag": {
              "type": "string",
              "defaultValue": "latest",
              "metadata": {
                "description": "Container image tag"
              }
            },
            "targetPort": {
              "type": "int",
              "defaultValue": 8080,
              "metadata": {
                "description": "Target port for the container"
              }
            },
            "isExternal": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Whether the app is externally accessible"
              }
            },
            "cpu": {
              "type": "string",
              "defaultValue": "0.5",
              "metadata": {
                "description": "CPU allocation (e.g., 0.5, 1, 2)"
              }
            },
            "memory": {
              "type": "string",
              "defaultValue": "1Gi",
              "metadata": {
                "description": "Memory allocation (e.g., 1Gi, 2Gi)"
              }
            },
            "minReplicas": {
              "type": "int",
              "defaultValue": 1,
              "minValue": 0,
              "maxValue": 30,
              "metadata": {
                "description": "Minimum number of replicas"
              }
            },
            "maxReplicas": {
              "type": "int",
              "defaultValue": 3,
              "minValue": 1,
              "maxValue": 30,
              "metadata": {
                "description": "Maximum number of replicas"
              }
            },
            "envVars": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Environment variables for the container"
              }
            },
            "secrets": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Secrets for the container (Key Vault references)"
              }
            },
            "transportProtocol": {
              "type": "string",
              "defaultValue": "auto",
              "allowedValues": [
                "auto",
                "http",
                "http2"
              ],
              "metadata": {
                "description": "Transport protocol (auto, http, http2)"
              }
            },
            "workloadProfileName": {
              "type": "string",
              "defaultValue": "Consumption",
              "metadata": {
                "description": "Workload profile name"
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "secretsConfig",
                "count": "[length(parameters('secrets'))]",
                "input": {
                  "name": "[parameters('secrets')[copyIndex('secretsConfig')].name]",
                  "keyVaultUrl": "[parameters('secrets')[copyIndex('secretsConfig')].keyVaultSecretUri]",
                  "identity": "[parameters('managedIdentityId')]"
                }
              },
              {
                "name": "secretEnvVars",
                "count": "[length(parameters('secrets'))]",
                "input": {
                  "name": "[replace(toUpper(replace(parameters('secrets')[copyIndex('secretEnvVars')].name, '-', '_')), ' ', '_')]",
                  "secretRef": "[parameters('secrets')[copyIndex('secretEnvVars')].name]"
                }
              }
            ],
            "allEnvVars": "[union(parameters('envVars'), variables('secretEnvVars'))]"
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[parameters('containerAppsEnvId')]",
                "workloadProfileName": "[parameters('workloadProfileName')]",
                "configuration": {
                  "activeRevisionsMode": "Single",
                  "ingress": {
                    "external": "[parameters('isExternal')]",
                    "targetPort": "[parameters('targetPort')]",
                    "transport": "[parameters('transportProtocol')]",
                    "allowInsecure": false,
                    "traffic": [
                      {
                        "latestRevision": true,
                        "weight": 100
                      }
                    ],
                    "corsPolicy": "[if(parameters('isExternal'), createObject('allowedOrigins', createArray('*'), 'allowedMethods', createArray('GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'), 'allowedHeaders', createArray('*'), 'maxAge', 86400), null())]"
                  },
                  "registries": [
                    {
                      "server": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-11-01-preview').loginServer]",
                      "identity": "[parameters('managedIdentityId')]"
                    }
                  ],
                  "secrets": "[variables('secretsConfig')]"
                },
                "template": {
                  "containers": [
                    {
                      "name": "[parameters('imageName')]",
                      "image": "[format('{0}/{1}:{2}', reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-11-01-preview').loginServer, parameters('imageName'), parameters('imageTag'))]",
                      "resources": {
                        "cpu": "[json(parameters('cpu'))]",
                        "memory": "[parameters('memory')]"
                      },
                      "env": "[variables('allEnvVars')]",
                      "probes": [
                        {
                          "type": "Liveness",
                          "httpGet": {
                            "path": "/health",
                            "port": "[parameters('targetPort')]"
                          },
                          "initialDelaySeconds": 30,
                          "periodSeconds": 30,
                          "failureThreshold": 3
                        },
                        {
                          "type": "Readiness",
                          "httpGet": {
                            "path": "/health",
                            "port": "[parameters('targetPort')]"
                          },
                          "initialDelaySeconds": 10,
                          "periodSeconds": 10,
                          "failureThreshold": 3
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": "[parameters('minReplicas')]",
                    "maxReplicas": "[parameters('maxReplicas')]",
                    "rules": [
                      {
                        "name": "http-scaling",
                        "http": {
                          "metadata": {
                            "concurrentRequests": "100"
                          }
                        }
                      }
                    ]
                  }
                }
              }
            }
          ],
          "outputs": {
            "containerAppId": {
              "type": "string",
              "metadata": {
                "description": "Container App resource ID"
              },
              "value": "[resourceId('Microsoft.App/containerApps', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Container App name"
              },
              "value": "[parameters('name')]"
            },
            "fqdn": {
              "type": "string",
              "metadata": {
                "description": "Container App FQDN"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').configuration.ingress.fqdn]"
            },
            "latestRevisionName": {
              "type": "string",
              "metadata": {
                "description": "Container App latest revision name"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').latestRevisionName]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'app-insights-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'container-apps-env-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'container-registry-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'key-vault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'redis-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "user-app-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('ca-user-{0}', parameters('environment'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "containerAppsEnvId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-apps-env-deployment'), '2025-04-01').outputs.environmentId.value]"
          },
          "containerRegistryName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-registry-deployment'), '2025-04-01').outputs.name.value]"
          },
          "managedIdentityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment'), '2025-04-01').outputs.identityId.value]"
          },
          "imageName": {
            "value": "user-service"
          },
          "imageTag": {
            "value": "[parameters('imageTag')]"
          },
          "targetPort": {
            "value": 8005
          },
          "isExternal": {
            "value": false
          },
          "cpu": {
            "value": "0.25"
          },
          "memory": {
            "value": "0.5Gi"
          },
          "minReplicas": {
            "value": 1
          },
          "maxReplicas": "[if(equals(parameters('environment'), 'prod'), createObject('value', 5), createObject('value', 2))]",
          "envVars": {
            "value": [
              {
                "name": "REDIS_URL",
                "value": "[format('rediss://{0}:{1}', reference(resourceId('Microsoft.Resources/deployments', 'redis-deployment'), '2025-04-01').outputs.hostname.value, reference(resourceId('Microsoft.Resources/deployments', 'redis-deployment'), '2025-04-01').outputs.sslPort.value)]"
              },
              {
                "name": "AZURE_CLIENT_ID",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment'), '2025-04-01').outputs.clientId.value]"
              },
              {
                "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-insights-deployment'), '2025-04-01').outputs.connectionString.value]"
              }
            ]
          },
          "secrets": {
            "value": [
              {
                "name": "redis-password",
                "keyVaultSecretUri": "[format('{0}secrets/redis-password', reference(resourceId('Microsoft.Resources/deployments', 'key-vault-deployment'), '2025-04-01').outputs.vaultUri.value)]"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "1548461273443967945"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container App"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the resource"
              }
            },
            "containerAppsEnvId": {
              "type": "string",
              "metadata": {
                "description": "Container Apps Environment ID"
              }
            },
            "containerRegistryName": {
              "type": "string",
              "metadata": {
                "description": "Container Registry name"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "User-Assigned Managed Identity ID"
              }
            },
            "imageName": {
              "type": "string",
              "metadata": {
                "description": "Container image name (without registry)"
              }
            },
            "imageTag": {
              "type": "string",
              "defaultValue": "latest",
              "metadata": {
                "description": "Container image tag"
              }
            },
            "targetPort": {
              "type": "int",
              "defaultValue": 8080,
              "metadata": {
                "description": "Target port for the container"
              }
            },
            "isExternal": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Whether the app is externally accessible"
              }
            },
            "cpu": {
              "type": "string",
              "defaultValue": "0.5",
              "metadata": {
                "description": "CPU allocation (e.g., 0.5, 1, 2)"
              }
            },
            "memory": {
              "type": "string",
              "defaultValue": "1Gi",
              "metadata": {
                "description": "Memory allocation (e.g., 1Gi, 2Gi)"
              }
            },
            "minReplicas": {
              "type": "int",
              "defaultValue": 1,
              "minValue": 0,
              "maxValue": 30,
              "metadata": {
                "description": "Minimum number of replicas"
              }
            },
            "maxReplicas": {
              "type": "int",
              "defaultValue": 3,
              "minValue": 1,
              "maxValue": 30,
              "metadata": {
                "description": "Maximum number of replicas"
              }
            },
            "envVars": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Environment variables for the container"
              }
            },
            "secrets": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Secrets for the container (Key Vault references)"
              }
            },
            "transportProtocol": {
              "type": "string",
              "defaultValue": "auto",
              "allowedValues": [
                "auto",
                "http",
                "http2"
              ],
              "metadata": {
                "description": "Transport protocol (auto, http, http2)"
              }
            },
            "workloadProfileName": {
              "type": "string",
              "defaultValue": "Consumption",
              "metadata": {
                "description": "Workload profile name"
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "secretsConfig",
                "count": "[length(parameters('secrets'))]",
                "input": {
                  "name": "[parameters('secrets')[copyIndex('secretsConfig')].name]",
                  "keyVaultUrl": "[parameters('secrets')[copyIndex('secretsConfig')].keyVaultSecretUri]",
                  "identity": "[parameters('managedIdentityId')]"
                }
              },
              {
                "name": "secretEnvVars",
                "count": "[length(parameters('secrets'))]",
                "input": {
                  "name": "[replace(toUpper(replace(parameters('secrets')[copyIndex('secretEnvVars')].name, '-', '_')), ' ', '_')]",
                  "secretRef": "[parameters('secrets')[copyIndex('secretEnvVars')].name]"
                }
              }
            ],
            "allEnvVars": "[union(parameters('envVars'), variables('secretEnvVars'))]"
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[parameters('containerAppsEnvId')]",
                "workloadProfileName": "[parameters('workloadProfileName')]",
                "configuration": {
                  "activeRevisionsMode": "Single",
                  "ingress": {
                    "external": "[parameters('isExternal')]",
                    "targetPort": "[parameters('targetPort')]",
                    "transport": "[parameters('transportProtocol')]",
                    "allowInsecure": false,
                    "traffic": [
                      {
                        "latestRevision": true,
                        "weight": 100
                      }
                    ],
                    "corsPolicy": "[if(parameters('isExternal'), createObject('allowedOrigins', createArray('*'), 'allowedMethods', createArray('GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'), 'allowedHeaders', createArray('*'), 'maxAge', 86400), null())]"
                  },
                  "registries": [
                    {
                      "server": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-11-01-preview').loginServer]",
                      "identity": "[parameters('managedIdentityId')]"
                    }
                  ],
                  "secrets": "[variables('secretsConfig')]"
                },
                "template": {
                  "containers": [
                    {
                      "name": "[parameters('imageName')]",
                      "image": "[format('{0}/{1}:{2}', reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-11-01-preview').loginServer, parameters('imageName'), parameters('imageTag'))]",
                      "resources": {
                        "cpu": "[json(parameters('cpu'))]",
                        "memory": "[parameters('memory')]"
                      },
                      "env": "[variables('allEnvVars')]",
                      "probes": [
                        {
                          "type": "Liveness",
                          "httpGet": {
                            "path": "/health",
                            "port": "[parameters('targetPort')]"
                          },
                          "initialDelaySeconds": 30,
                          "periodSeconds": 30,
                          "failureThreshold": 3
                        },
                        {
                          "type": "Readiness",
                          "httpGet": {
                            "path": "/health",
                            "port": "[parameters('targetPort')]"
                          },
                          "initialDelaySeconds": 10,
                          "periodSeconds": 10,
                          "failureThreshold": 3
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": "[parameters('minReplicas')]",
                    "maxReplicas": "[parameters('maxReplicas')]",
                    "rules": [
                      {
                        "name": "http-scaling",
                        "http": {
                          "metadata": {
                            "concurrentRequests": "100"
                          }
                        }
                      }
                    ]
                  }
                }
              }
            }
          ],
          "outputs": {
            "containerAppId": {
              "type": "string",
              "metadata": {
                "description": "Container App resource ID"
              },
              "value": "[resourceId('Microsoft.App/containerApps', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Container App name"
              },
              "value": "[parameters('name')]"
            },
            "fqdn": {
              "type": "string",
              "metadata": {
                "description": "Container App FQDN"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').configuration.ingress.fqdn]"
            },
            "latestRevisionName": {
              "type": "string",
              "metadata": {
                "description": "Container App latest revision name"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').latestRevisionName]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'app-insights-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'container-apps-env-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'container-registry-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'key-vault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'redis-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "ingestion-app-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('ca-ingestion-{0}', parameters('environment'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "containerAppsEnvId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-apps-env-deployment'), '2025-04-01').outputs.environmentId.value]"
          },
          "containerRegistryName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-registry-deployment'), '2025-04-01').outputs.name.value]"
          },
          "managedIdentityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment'), '2025-04-01').outputs.identityId.value]"
          },
          "imageName": {
            "value": "ingestion-service"
          },
          "imageTag": {
            "value": "[parameters('imageTag')]"
          },
          "targetPort": {
            "value": 50051
          },
          "isExternal": {
            "value": false
          },
          "cpu": {
            "value": "1"
          },
          "memory": {
            "value": "2Gi"
          },
          "minReplicas": {
            "value": 1
          },
          "maxReplicas": "[if(equals(parameters('environment'), 'prod'), createObject('value', 5), createObject('value', 2))]",
          "transportProtocol": {
            "value": "http2"
          },
          "envVars": {
            "value": [
              {
                "name": "AZURE_CLIENT_ID",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment'), '2025-04-01').outputs.clientId.value]"
              },
              {
                "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-insights-deployment'), '2025-04-01').outputs.connectionString.value]"
              }
            ]
          },
          "secrets": {
            "value": []
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "1548461273443967945"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container App"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the resource"
              }
            },
            "containerAppsEnvId": {
              "type": "string",
              "metadata": {
                "description": "Container Apps Environment ID"
              }
            },
            "containerRegistryName": {
              "type": "string",
              "metadata": {
                "description": "Container Registry name"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "User-Assigned Managed Identity ID"
              }
            },
            "imageName": {
              "type": "string",
              "metadata": {
                "description": "Container image name (without registry)"
              }
            },
            "imageTag": {
              "type": "string",
              "defaultValue": "latest",
              "metadata": {
                "description": "Container image tag"
              }
            },
            "targetPort": {
              "type": "int",
              "defaultValue": 8080,
              "metadata": {
                "description": "Target port for the container"
              }
            },
            "isExternal": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Whether the app is externally accessible"
              }
            },
            "cpu": {
              "type": "string",
              "defaultValue": "0.5",
              "metadata": {
                "description": "CPU allocation (e.g., 0.5, 1, 2)"
              }
            },
            "memory": {
              "type": "string",
              "defaultValue": "1Gi",
              "metadata": {
                "description": "Memory allocation (e.g., 1Gi, 2Gi)"
              }
            },
            "minReplicas": {
              "type": "int",
              "defaultValue": 1,
              "minValue": 0,
              "maxValue": 30,
              "metadata": {
                "description": "Minimum number of replicas"
              }
            },
            "maxReplicas": {
              "type": "int",
              "defaultValue": 3,
              "minValue": 1,
              "maxValue": 30,
              "metadata": {
                "description": "Maximum number of replicas"
              }
            },
            "envVars": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Environment variables for the container"
              }
            },
            "secrets": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Secrets for the container (Key Vault references)"
              }
            },
            "transportProtocol": {
              "type": "string",
              "defaultValue": "auto",
              "allowedValues": [
                "auto",
                "http",
                "http2"
              ],
              "metadata": {
                "description": "Transport protocol (auto, http, http2)"
              }
            },
            "workloadProfileName": {
              "type": "string",
              "defaultValue": "Consumption",
              "metadata": {
                "description": "Workload profile name"
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "secretsConfig",
                "count": "[length(parameters('secrets'))]",
                "input": {
                  "name": "[parameters('secrets')[copyIndex('secretsConfig')].name]",
                  "keyVaultUrl": "[parameters('secrets')[copyIndex('secretsConfig')].keyVaultSecretUri]",
                  "identity": "[parameters('managedIdentityId')]"
                }
              },
              {
                "name": "secretEnvVars",
                "count": "[length(parameters('secrets'))]",
                "input": {
                  "name": "[replace(toUpper(replace(parameters('secrets')[copyIndex('secretEnvVars')].name, '-', '_')), ' ', '_')]",
                  "secretRef": "[parameters('secrets')[copyIndex('secretEnvVars')].name]"
                }
              }
            ],
            "allEnvVars": "[union(parameters('envVars'), variables('secretEnvVars'))]"
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[parameters('containerAppsEnvId')]",
                "workloadProfileName": "[parameters('workloadProfileName')]",
                "configuration": {
                  "activeRevisionsMode": "Single",
                  "ingress": {
                    "external": "[parameters('isExternal')]",
                    "targetPort": "[parameters('targetPort')]",
                    "transport": "[parameters('transportProtocol')]",
                    "allowInsecure": false,
                    "traffic": [
                      {
                        "latestRevision": true,
                        "weight": 100
                      }
                    ],
                    "corsPolicy": "[if(parameters('isExternal'), createObject('allowedOrigins', createArray('*'), 'allowedMethods', createArray('GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'), 'allowedHeaders', createArray('*'), 'maxAge', 86400), null())]"
                  },
                  "registries": [
                    {
                      "server": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-11-01-preview').loginServer]",
                      "identity": "[parameters('managedIdentityId')]"
                    }
                  ],
                  "secrets": "[variables('secretsConfig')]"
                },
                "template": {
                  "containers": [
                    {
                      "name": "[parameters('imageName')]",
                      "image": "[format('{0}/{1}:{2}', reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-11-01-preview').loginServer, parameters('imageName'), parameters('imageTag'))]",
                      "resources": {
                        "cpu": "[json(parameters('cpu'))]",
                        "memory": "[parameters('memory')]"
                      },
                      "env": "[variables('allEnvVars')]",
                      "probes": [
                        {
                          "type": "Liveness",
                          "httpGet": {
                            "path": "/health",
                            "port": "[parameters('targetPort')]"
                          },
                          "initialDelaySeconds": 30,
                          "periodSeconds": 30,
                          "failureThreshold": 3
                        },
                        {
                          "type": "Readiness",
                          "httpGet": {
                            "path": "/health",
                            "port": "[parameters('targetPort')]"
                          },
                          "initialDelaySeconds": 10,
                          "periodSeconds": 10,
                          "failureThreshold": 3
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": "[parameters('minReplicas')]",
                    "maxReplicas": "[parameters('maxReplicas')]",
                    "rules": [
                      {
                        "name": "http-scaling",
                        "http": {
                          "metadata": {
                            "concurrentRequests": "100"
                          }
                        }
                      }
                    ]
                  }
                }
              }
            }
          ],
          "outputs": {
            "containerAppId": {
              "type": "string",
              "metadata": {
                "description": "Container App resource ID"
              },
              "value": "[resourceId('Microsoft.App/containerApps', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Container App name"
              },
              "value": "[parameters('name')]"
            },
            "fqdn": {
              "type": "string",
              "metadata": {
                "description": "Container App FQDN"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').configuration.ingress.fqdn]"
            },
            "latestRevisionName": {
              "type": "string",
              "metadata": {
                "description": "Container App latest revision name"
              },
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').latestRevisionName]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'app-insights-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'container-apps-env-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'container-registry-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "role-assignments-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment'), '2025-04-01').outputs.principalId.value]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-account-deployment'), '2025-04-01').outputs.name.value]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'key-vault-deployment'), '2025-04-01').outputs.name.value]"
          },
          "containerRegistryName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-registry-deployment'), '2025-04-01').outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "14734435135866171432"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the managed identity"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage Account name"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              }
            },
            "containerRegistryName": {
              "type": "string",
              "metadata": {
                "description": "Container Registry name"
              }
            }
          },
          "variables": {
            "roles": {
              "storageBlobDataContributor": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
              "keyVaultSecretsUser": "4633458b-17de-408a-b874-0445c86b69e6",
              "acrPull": "7f951dda-4ed3-4680-a7ca-43fe172d538d",
              "acrPush": "8311e382-0749-4cb8-b61a-304f252e45ec"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('principalId'), variables('roles').storageBlobDataContributor)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageBlobDataContributor)]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('principalId'), variables('roles').keyVaultSecretsUser)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').keyVaultSecretsUser)]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('containerRegistryName'))]",
              "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), parameters('principalId'), variables('roles').acrPull)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').acrPull)]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ],
          "outputs": {
            "storageRoleId": {
              "type": "string",
              "metadata": {
                "description": "Storage role assignment ID"
              },
              "value": "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('principalId'), variables('roles').storageBlobDataContributor))]"
            },
            "keyVaultRoleId": {
              "type": "string",
              "metadata": {
                "description": "Key Vault role assignment ID"
              },
              "value": "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('principalId'), variables('roles').keyVaultSecretsUser))]"
            },
            "acrRoleId": {
              "type": "string",
              "metadata": {
                "description": "ACR role assignment ID"
              },
              "value": "[extensionResourceId(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), parameters('principalId'), variables('roles').acrPull))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'container-registry-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'key-vault-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'storage-account-deployment')]"
      ]
    }
  ],
  "outputs": {
    "frontendUrl": {
      "type": "string",
      "metadata": {
        "description": "Frontend application URL"
      },
      "value": "[format('https://{0}', reference(resourceId('Microsoft.Resources/deployments', 'frontend-app-deployment'), '2025-04-01').outputs.fqdn.value)]"
    },
    "gatewayUrl": {
      "type": "string",
      "metadata": {
        "description": "Gateway API URL"
      },
      "value": "[format('https://{0}', reference(resourceId('Microsoft.Resources/deployments', 'gateway-app-deployment'), '2025-04-01').outputs.fqdn.value)]"
    },
    "containerRegistryLoginServer": {
      "type": "string",
      "metadata": {
        "description": "Container Registry login server"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-registry-deployment'), '2025-04-01').outputs.loginServer.value]"
    },
    "keyVaultUri": {
      "type": "string",
      "metadata": {
        "description": "Key Vault URI"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'key-vault-deployment'), '2025-04-01').outputs.vaultUri.value]"
    },
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "Storage Account name"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'storage-account-deployment'), '2025-04-01').outputs.name.value]"
    },
    "redisHostname": {
      "type": "string",
      "metadata": {
        "description": "Redis hostname"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'redis-deployment'), '2025-04-01').outputs.hostname.value]"
    },
    "appInsightsConnectionString": {
      "type": "string",
      "metadata": {
        "description": "Application Insights connection string"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app-insights-deployment'), '2025-04-01').outputs.connectionString.value]"
    },
    "managedIdentityClientId": {
      "type": "string",
      "metadata": {
        "description": "Managed Identity client ID"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managed-identity-deployment'), '2025-04-01').outputs.clientId.value]"
    },
    "containerAppsDefaultDomain": {
      "type": "string",
      "metadata": {
        "description": "Container Apps Environment default domain"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'container-apps-env-deployment'), '2025-04-01').outputs.defaultDomain.value]"
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "metadata": {
        "description": "Log Analytics Workspace ID"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'log-analytics-deployment'), '2025-04-01').outputs.workspaceId.value]"
    }
  }
}