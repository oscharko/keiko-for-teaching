---
# External Secrets Operator Configuration
# This provides declarative secret management from Azure Key Vault

# SecretStore for Azure Key Vault (keiko-teaching namespace)
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: azure-keyvault-store
  namespace: keiko-teaching
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secrets
spec:
  provider:
    azurekv:
      authType: ManagedIdentity
      vaultUrl: "https://${KEY_VAULT_NAME}.vault.azure.net"
      identityId: "${AZURE_CLIENT_ID}"
      tenantId: "${AZURE_TENANT_ID}"

---
# SecretStore for Azure Key Vault (monitoring namespace)
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: azure-keyvault-store
  namespace: monitoring
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secrets
spec:
  provider:
    azurekv:
      authType: ManagedIdentity
      vaultUrl: "https://${KEY_VAULT_NAME}.vault.azure.net"
      identityId: "${AZURE_CLIENT_ID}"
      tenantId: "${AZURE_TENANT_ID}"

---
# ClusterSecretStore for cluster-wide access
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: azure-keyvault-cluster-store
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secrets
spec:
  provider:
    azurekv:
      authType: ManagedIdentity
      vaultUrl: "https://${KEY_VAULT_NAME}.vault.azure.net"
      identityId: "${AZURE_CLIENT_ID}"
      tenantId: "${AZURE_TENANT_ID}"

---
# ExternalSecret for OpenAI credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: openai-credentials
  namespace: keiko-teaching
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault-store
    kind: SecretStore
  target:
    name: openai-credentials
    creationPolicy: Owner
    template:
      type: Opaque
  data:
    - secretKey: api-key
      remoteRef:
        key: openai-api-key

---
# ExternalSecret for Redis credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-credentials
  namespace: keiko-teaching
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault-store
    kind: SecretStore
  target:
    name: redis-credentials
    creationPolicy: Owner
    template:
      type: Opaque
  data:
    - secretKey: password
      remoteRef:
        key: redis-password

---
# ExternalSecret for Azure Search credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: azure-search-credentials
  namespace: keiko-teaching
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault-store
    kind: SecretStore
  target:
    name: azure-search-credentials
    creationPolicy: Owner
    template:
      type: Opaque
  data:
    - secretKey: api-key
      remoteRef:
        key: azure-search-api-key

---
# ExternalSecret for Azure Storage credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: azure-storage-credentials
  namespace: keiko-teaching
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault-store
    kind: SecretStore
  target:
    name: azure-storage-credentials
    creationPolicy: Owner
    template:
      type: Opaque
  data:
    - secretKey: connection-string
      remoteRef:
        key: azure-storage-connection-string

---
# ExternalSecret for JWT credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: jwt-credentials
  namespace: keiko-teaching
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault-store
    kind: SecretStore
  target:
    name: jwt-credentials
    creationPolicy: Owner
    template:
      type: Opaque
  data:
    - secretKey: secret-key
      remoteRef:
        key: jwt-secret-key

---
# ExternalSecret for Azure AD credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: azure-ad-credentials
  namespace: keiko-teaching
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault-store
    kind: SecretStore
  target:
    name: azure-ad-credentials
    creationPolicy: Owner
    template:
      type: Opaque
  data:
    - secretKey: client-id
      remoteRef:
        key: azure-ad-client-id
    - secretKey: client-secret
      remoteRef:
        key: azure-ad-client-secret

---
# ExternalSecret for Grafana credentials (monitoring namespace)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: grafana-secrets
  namespace: monitoring
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault-store
    kind: SecretStore
  target:
    name: grafana-secrets
    creationPolicy: Owner
    template:
      type: Opaque
  data:
    - secretKey: admin-password
      remoteRef:
        key: grafana-admin-password
    - secretKey: secret-key
      remoteRef:
        key: grafana-secret-key

---
# ExternalSecret for Azure Monitor credentials (monitoring namespace)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: azure-monitor-credentials
  namespace: monitoring
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault-store
    kind: SecretStore
  target:
    name: azure-monitor-credentials
    creationPolicy: Owner
    template:
      type: Opaque
  data:
    - secretKey: endpoint
      remoteRef:
        key: azure-monitor-endpoint
    - secretKey: api-key
      remoteRef:
        key: azure-monitor-api-key

---
# ExternalSecret for Azure credentials (monitoring namespace)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: azure-credentials
  namespace: monitoring
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault-store
    kind: SecretStore
  target:
    name: azure-credentials
    creationPolicy: Owner
    template:
      type: Opaque
  data:
    - secretKey: subscription-id
      remoteRef:
        key: azure-subscription-id
    - secretKey: tenant-id
      remoteRef:
        key: azure-tenant-id
    - secretKey: client-id
      remoteRef:
        key: azure-client-id
    - secretKey: client-secret
      remoteRef:
        key: azure-client-secret

---
# Installation instructions for External Secrets Operator
# Run these commands to install the operator:
#
# 1. Install External Secrets Operator
# helm repo add external-secrets https://charts.external-secrets.io
# helm repo update
# helm install external-secrets external-secrets/external-secrets \
#   --namespace external-secrets-system \
#   --create-namespace \
#   --set installCRDs=true
#
# 2. Apply the SecretStore and ExternalSecret resources
# kubectl apply -f external-secrets-operator.yaml

