---
# CSI Secrets Store Driver Installation
# This uses Helm chart values for the Azure Key Vault Provider

# Namespace for secrets management
apiVersion: v1
kind: Namespace
metadata:
  name: kube-system
  labels:
    name: kube-system

---
# SecretProviderClass for Azure Key Vault
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: azure-keyvault-secrets
  namespace: keiko-teaching
  labels:
    app.kubernetes.io/name: azure-keyvault-secrets
    app.kubernetes.io/component: secrets
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "true"
    userAssignedIdentityID: "${AZURE_CLIENT_ID}"
    keyvaultName: "${KEY_VAULT_NAME}"
    cloudName: "AzurePublicCloud"
    objects: |
      array:
        - |
          objectName: openai-api-key
          objectType: secret
          objectVersion: ""
        - |
          objectName: redis-password
          objectType: secret
          objectVersion: ""
        - |
          objectName: azure-search-api-key
          objectType: secret
          objectVersion: ""
        - |
          objectName: azure-storage-connection-string
          objectType: secret
          objectVersion: ""
        - |
          objectName: jwt-secret-key
          objectType: secret
          objectVersion: ""
        - |
          objectName: azure-ad-client-secret
          objectType: secret
          objectVersion: ""
        - |
          objectName: grafana-admin-password
          objectType: secret
          objectVersion: ""
        - |
          objectName: grafana-secret-key
          objectType: secret
          objectVersion: ""
        - |
          objectName: azure-monitor-api-key
          objectType: secret
          objectVersion: ""
    tenantId: "${AZURE_TENANT_ID}"
  secretObjects:
    - secretName: openai-credentials
      type: Opaque
      data:
        - objectName: openai-api-key
          key: api-key
    - secretName: redis-credentials
      type: Opaque
      data:
        - objectName: redis-password
          key: password
    - secretName: azure-search-credentials
      type: Opaque
      data:
        - objectName: azure-search-api-key
          key: api-key
    - secretName: azure-storage-credentials
      type: Opaque
      data:
        - objectName: azure-storage-connection-string
          key: connection-string
    - secretName: jwt-credentials
      type: Opaque
      data:
        - objectName: jwt-secret-key
          key: secret-key
    - secretName: azure-ad-credentials
      type: Opaque
      data:
        - objectName: azure-ad-client-secret
          key: client-secret
    - secretName: grafana-secrets
      type: Opaque
      data:
        - objectName: grafana-admin-password
          key: admin-password
        - objectName: grafana-secret-key
          key: secret-key
    - secretName: azure-monitor-credentials
      type: Opaque
      data:
        - objectName: azure-monitor-api-key
          key: api-key

---
# SecretProviderClass for Monitoring Namespace
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: azure-keyvault-monitoring-secrets
  namespace: monitoring
  labels:
    app.kubernetes.io/name: azure-keyvault-monitoring-secrets
    app.kubernetes.io/component: secrets
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "true"
    userAssignedIdentityID: "${AZURE_CLIENT_ID}"
    keyvaultName: "${KEY_VAULT_NAME}"
    cloudName: "AzurePublicCloud"
    objects: |
      array:
        - |
          objectName: grafana-admin-password
          objectType: secret
          objectVersion: ""
        - |
          objectName: grafana-secret-key
          objectType: secret
          objectVersion: ""
        - |
          objectName: azure-monitor-api-key
          objectType: secret
          objectVersion: ""
        - |
          objectName: azure-subscription-id
          objectType: secret
          objectVersion: ""
        - |
          objectName: azure-client-id
          objectType: secret
          objectVersion: ""
        - |
          objectName: azure-client-secret
          objectType: secret
          objectVersion: ""
        - |
          objectName: azure-ad-client-id
          objectType: secret
          objectVersion: ""
        - |
          objectName: azure-ad-client-secret
          objectType: secret
          objectVersion: ""
    tenantId: "${AZURE_TENANT_ID}"
  secretObjects:
    - secretName: grafana-secrets
      type: Opaque
      data:
        - objectName: grafana-admin-password
          key: admin-password
        - objectName: grafana-secret-key
          key: secret-key
    - secretName: azure-credentials
      type: Opaque
      data:
        - objectName: azure-subscription-id
          key: subscription-id
        - objectName: azure-client-id
          key: client-id
        - objectName: azure-client-secret
          key: client-secret
    - secretName: azure-ad-credentials
      type: Opaque
      data:
        - objectName: azure-ad-client-id
          key: client-id
        - objectName: azure-ad-client-secret
          key: client-secret
    - secretName: azure-monitor-credentials
      type: Opaque
      data:
        - objectName: azure-monitor-api-key
          key: api-key

---
# Installation instructions for CSI Secrets Store Driver
# Run these commands to install the driver:
#
# 1. Install the Secrets Store CSI Driver
# helm repo add secrets-store-csi-driver https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts
# helm repo update
# helm install csi-secrets-store secrets-store-csi-driver/secrets-store-csi-driver \
#   --namespace kube-system \
#   --set syncSecret.enabled=true \
#   --set enableSecretRotation=true \
#   --set rotationPollInterval=2m
#
# 2. Install the Azure Key Vault Provider
# helm repo add csi-secrets-store-provider-azure https://azure.github.io/secrets-store-csi-driver-provider-azure/charts
# helm repo update
# helm install azure-csi-provider csi-secrets-store-provider-azure/csi-secrets-store-provider-azure \
#   --namespace kube-system
#
# 3. Apply the SecretProviderClass resources
# kubectl apply -f csi-secrets-store.yaml

